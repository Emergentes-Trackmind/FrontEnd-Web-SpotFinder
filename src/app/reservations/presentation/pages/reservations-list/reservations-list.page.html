<div class="reservations-container">
  <!-- Header -->
  <div class="page-header">
    <h1 class="page-title">Gestión de Reservas</h1>
    <div class="header-actions">
      <span class="support-link">Soporte</span>
      <span class="account-link">Cuenta</span>
    </div>
  </div>

  <!-- Filters Card -->
  <div class="filters-card">
    <!-- Search Input -->
    <div class="search-section">
      <mat-form-field class="search-field" appearance="outline">
        <mat-icon matPrefix>search</mat-icon>
        <input matInput
               placeholder="Buscar reservas..."
               [formControl]="searchControl">
      </mat-form-field>
    </div>

    <!-- Status Filter Chips -->
    <div class="chips-section">
      <mat-chip-set class="status-chips">
        <mat-chip
          *ngFor="let option of statusOptions; let i = index"
          [class]="option.chipClass"
          [class.selected]="selectedFilterIndex === i"
          (click)="onStatusFilterClick(i)">
          {{ option.label }}
        </mat-chip>
      </mat-chip-set>

      <button mat-stroked-button
              color="primary"
              class="more-filters-btn"
              (click)="onOpenAdvancedFilters()">
        <mat-icon>tune</mat-icon>
        Más filtros
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content-layout" [class.with-detail]="isDetailPanelOpen">
    <!-- Table Card -->
    <div class="table-card">
      <div class="table-header">
        <h2 class="table-title">Lista de reservas</h2>
        <div class="table-actions">
          <button mat-button (click)="onExportCsv()">
            <mat-icon>download</mat-icon>
            Exportar CSV
          </button>
        </div>
      </div>

      <div class="table-container">
        <table mat-table
               [dataSource]="dataSource"
               matSort
               class="reservations-table">

          <!-- ID Column -->
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef>ID</th>
            <td mat-cell *matCellDef="let reservation">#{{ reservation.id }}</td>
          </ng-container>

          <!-- Usuario Column -->
          <ng-container matColumnDef="userName">
            <th mat-header-cell *matHeaderCellDef>Usuario</th>
            <td mat-cell *matCellDef="let reservation">{{ reservation.userName || 'N/A' }}</td>
          </ng-container>

          <!-- Fecha/Hora Column -->
          <ng-container matColumnDef="startTime">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha/Hora</th>
            <td mat-cell *matCellDef="let reservation">{{ formatDateTime(reservation.startTime) }}</td>
          </ng-container>

          <!-- Estado Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Estado</th>
            <td mat-cell *matCellDef="let reservation">
              <app-status-pill [status]="reservation.status"></app-status-pill>
            </td>
          </ng-container>

          <!-- Monto Column -->
          <ng-container matColumnDef="totalPrice">
            <th mat-header-cell *matHeaderCellDef>Monto</th>
            <td mat-cell *matCellDef="let reservation">
              {{ formatCurrency(reservation.totalPrice, reservation.currency) }}
            </td>
          </ng-container>

          <!-- Acciones Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let reservation">
              <button mat-icon-button [matMenuTriggerFor]="actionsMenu" (click)="$event.stopPropagation()">
                <mat-icon>more_horiz</mat-icon>
              </button>
              <mat-menu #actionsMenu="matMenu">
                <button mat-menu-item
                        *ngIf="canConfirm(reservation.status)"
                        (click)="onConfirmReservation(reservation, $event)">
                  <mat-icon>check_circle</mat-icon>
                  <span>Confirmar</span>
                </button>
                <button mat-menu-item
                        *ngIf="canCancel(reservation.status)"
                        (click)="onCancelReservation(reservation, $event)">
                  <mat-icon>cancel</mat-icon>
                  <span>Cancelar</span>
                </button>
                <button mat-menu-item (click)="exportSingleReservation(reservation)">
                  <mat-icon>download</mat-icon>
                  <span>Exportar CSV</span>
                </button>
              </mat-menu>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row
              *matRowDef="let row; columns: displayedColumns;"
              class="table-row"
              (click)="onRowClick(row)"></tr>
        </table>

        <!-- Paginator -->
        <mat-paginator
          [pageSizeOptions]="[5, 10, 20, 50]"
          [pageSize]="10"
          [showFirstLastButtons]="true"
          (page)="onPageChange($event)"
          class="table-paginator">
        </mat-paginator>
      </div>
    </div>

    <!-- Detail Panel (Desktop only) -->
    <div class="detail-panel"
         *ngIf="isDetailPanelOpen && selectedReservation">
      <div class="detail-card">
        <div class="detail-header">
          <h2 class="detail-title">
            Detalle de reserva #{{ selectedReservation?.id }}
          </h2>
          <button mat-icon-button (click)="closeReservationDetail()">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <div class="detail-content">
          <div class="detail-field">
            <label class="field-label">Usuario</label>
            <div class="field-value">{{ selectedReservation?.userName }}</div>
          </div>

          <div class="detail-field">
            <label class="field-label">Email</label>
            <div class="field-value">{{ selectedReservation?.userEmail }}</div>
          </div>

          <div class="detail-field">
            <label class="field-label">Horario</label>
            <div class="field-value">
              {{ formatDateTime(selectedReservation?.startTime || '') }} -
              {{ formatDateTime(selectedReservation?.endTime || '') }}
            </div>
          </div>

          <div class="detail-field">
            <label class="field-label">Espacio</label>
            <div class="field-value">{{ selectedReservation?.space || 'N/A' }}</div>
          </div>

          <div class="detail-field">
            <label class="field-label">Monto</label>
            <div class="field-value">
              {{ formatCurrency(selectedReservation?.totalPrice || 0,
                                selectedReservation?.currency || 'USD') }}
            </div>
          </div>
        </div>

        <div class="detail-actions">
          <button mat-flat-button
                  color="accent"
                  class="confirm-btn"
                  *ngIf="canConfirm(selectedReservation?.status!)"
                  (click)="onConfirmReservation(selectedReservation!, $event)">
            Confirmar
          </button>

          <button mat-stroked-button
                  class="cancel-btn"
                  *ngIf="canCancel(selectedReservation?.status!)"
                  (click)="onCancelReservation(selectedReservation!, $event)">
            Cancelar
          </button>

          <button mat-button
                  class="export-btn"
                  (click)="exportSingleReservation(selectedReservation!)">
            Exportar CSV
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
