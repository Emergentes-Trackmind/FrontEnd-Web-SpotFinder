<div class="reservations-container">

  <!-- KPI Cards Section -->
  <div class="kpi-section">
    <div class="kpi-card">
      <div class="kpi-icon total">
        <mat-icon>receipt_long</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">{{ 'RESERVATIONS.KPI.TOTAL_LABEL' | translate }}</div>
        <div class="kpi-value">{{ totalReservations }}</div>
        <div class="kpi-trend positive" *ngIf="totalTrend > 0">
          +{{ totalTrend }}% {{ 'RESERVATIONS.KPI.VS_PREVIOUS_MONTH' | translate }}
        </div>
        <div class="kpi-trend negative" *ngIf="totalTrend < 0">
          {{ totalTrend }}% {{ 'RESERVATIONS.KPI.VS_PREVIOUS_MONTH' | translate }}
        </div>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon pending">
        <mat-icon>schedule</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">{{ 'RESERVATIONS.KPI.PENDING_LABEL' | translate }}</div>
        <div class="kpi-value">{{ pendingReservations }}</div>
        <div class="kpi-trend negative" *ngIf="pendingTrend !== 0">
          {{ pendingTrend > 0 ? '+' : '' }}{{ pendingTrend }}% {{ 'RESERVATIONS.KPI.VS_PREVIOUS_MONTH' | translate }}
        </div>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon confirmed">
        <mat-icon>check_circle</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">{{ 'RESERVATIONS.KPI.CONFIRMED_LABEL' | translate }}</div>
        <div class="kpi-value">{{ confirmedReservations }}</div>
        <div class="kpi-trend positive" *ngIf="confirmedTrend > 0">
          +{{ confirmedTrend }}% {{ 'RESERVATIONS.KPI.VS_PREVIOUS_MONTH' | translate }}
        </div>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon cancelled">
        <mat-icon>cancel</mat-icon>
      </div>
      <div class="kpi-content">
        <div class="kpi-label">{{ 'RESERVATIONS.KPI.CANCELLED_LABEL' | translate }}</div>
        <div class="kpi-value">{{ cancelledReservations }}</div>
        <div class="kpi-trend negative" *ngIf="cancelledTrend !== 0">
          {{ cancelledTrend > 0 ? '+' : '' }}{{ cancelledTrend }}% {{ 'RESERVATIONS.KPI.VS_PREVIOUS_MONTH' | translate }}
        </div>
      </div>
    </div>
  </div>

  <!-- Search and Filters Section -->
  <div class="search-filters-section">
    <div class="search-container">
      <mat-icon class="search-icon">search</mat-icon>
      <input type="text"
             class="search-input"
             placeholder="{{ 'RESERVATIONS.SEARCH.PLACEHOLDER' | translate }}"
             [formControl]="searchControl">
    </div>

    <div class="date-filter">
      <button mat-button class="date-filter-btn">
        {{ 'RESERVATIONS.FILTER.TODAY' | translate }}
        <mat-icon>arrow_drop_down</mat-icon>
      </button>
    </div>

    <div class="action-buttons">
      <button mat-stroked-button class="filter-btn">
        <mat-icon>filter_list</mat-icon>
        {{ 'RESERVATIONS.BUTTON.FILTERS' | translate }}
      </button>
      <button mat-flat-button color="warn" class="export-csv-btn" (click)="onExportCsv()">
        <mat-icon>download</mat-icon>
        {{ 'RESERVATIONS.BUTTON.EXPORT_CSV' | translate }}
      </button>
    </div>
  </div>

  <!-- Tabs Section -->
  <div class="tabs-section">
    <div class="tab-item"
         [class.active]="selectedFilterIndex === 0"
         (click)="onStatusFilterClick(0)">
      <span class="tab-label">{{ 'RESERVATIONS.TABS.ALL' | translate }}</span>
      <span class="tab-count">({{ totalReservations }})</span>
    </div>
    <div class="tab-item"
         [class.active]="selectedFilterIndex === 1"
         (click)="onStatusFilterClick(1)">
      <span class="tab-label">{{ 'RESERVATIONS.TABS.PENDING' | translate }}</span>
      <span class="tab-count">({{ pendingReservations }})</span>
    </div>
    <div class="tab-item"
         [class.active]="selectedFilterIndex === 2"
         (click)="onStatusFilterClick(2)">
      <span class="tab-label">{{ 'RESERVATIONS.TABS.CONFIRMED' | translate }}</span>
      <span class="tab-count">({{ confirmedReservations }})</span>
    </div>
    <div class="tab-item"
         [class.active]="selectedFilterIndex === 3"
         (click)="onStatusFilterClick(3)">
      <span class="tab-label">{{ 'RESERVATIONS.TABS.PAID' | translate }}</span>
      <span class="tab-count">({{ paidReservations }})</span>
    </div>
    <div class="tab-item"
         [class.active]="selectedFilterIndex === 4"
         (click)="onStatusFilterClick(4)">
      <span class="tab-label">{{ 'RESERVATIONS.TABS.CANCELLED' | translate }}</span>
      <span class="tab-count">({{ cancelledReservations }})</span>
    </div>
  </div>

  <!-- Main Content Layout -->
  <div class="content-layout" [class.with-detail]="isDetailPanelOpen">

    <!-- Lista de Reservas Card -->
    <div class="reservations-card">
      <!-- Header -->
      <div class="card-header">
        <h2 class="card-title">{{ 'RESERVATIONS.LIST.TITLE' | translate }}</h2>
      </div>

      <!-- Column Headers -->
      <div class="list-header">
        <div class="header-cliente">{{ 'RESERVATIONS.LIST.HEADER.CLIENT' | translate }}</div>
        <div class="header-parking">{{ 'RESERVATIONS.LIST.HEADER.PARKING' | translate }}</div>
        <div class="header-fecha">{{ 'RESERVATIONS.LIST.HEADER.DATE_TIME' | translate }}</div>
        <div class="header-estado">{{ 'RESERVATIONS.LIST.HEADER.STATUS' | translate }}</div>
        <div class="header-importe">{{ 'RESERVATIONS.LIST.HEADER.AMOUNT' | translate }}</div>
        <div class="header-acciones">{{ 'RESERVATIONS.LIST.HEADER.ACTIONS' | translate }}</div>
      </div>

      <!-- Reservations List -->
      <div class="reservations-list">
        <div *ngFor="let reservation of dataSource.data"
             class="reservation-item"
             (click)="onRowClick(reservation)">

          <!-- Cliente Column -->
          <div class="column-cliente">
            <div class="client-info">
              <div class="client-avatar">
                {{ getInitials(reservation.userName || 'U') }}
              </div>
              <div class="client-details">
                <div class="client-name">{{ reservation.userName || ('COMMON.N_A' | translate) }}</div>
                <div class="client-email">{{ reservation.userEmail || '' }}</div>
              </div>
            </div>
          </div>

          <!-- Parking Column -->
          <div class="column-parking">
            <div class="parking-info">
              <div class="parking-name">{{ reservation.parkingName || ('COMMON.N_A' | translate) }}</div>
              <div class="parking-location">
                <mat-icon class="location-icon">location_on</mat-icon>
                {{ reservation.space || ('COMMON.N_A' | translate) }}
              </div>
            </div>
          </div>

          <!-- Fecha y Hora Column -->
          <div class="column-fecha">
            <div class="date-info">
              <div class="date-day">
                <mat-icon class="calendar-icon">calendar_today</mat-icon>
                {{ formatDate(reservation.startTime) }}
              </div>
              <div class="date-time">
                <mat-icon class="time-icon">schedule</mat-icon>
                {{ formatTimeRange(reservation.startTime, reservation.endTime) }}
              </div>
            </div>
          </div>

          <!-- Estado Column -->
          <div class="column-estado">
            <app-status-pill [status]="reservation.status"></app-status-pill>
          </div>

          <!-- Importe Column -->
          <div class="column-importe">
            <div class="price-amount">{{ formatCurrencySimple(reservation.totalPrice, reservation.currency) }}</div>
          </div>

          <!-- Acciones Column -->
          <div class="column-acciones">
            <button mat-flat-button
                    color="primary"
                    class="ver-btn"
                    (click)="onViewDetails(reservation, $event)">
              <mat-icon>visibility</mat-icon>
              {{ 'RESERVATIONS.BUTTON.VIEW' | translate }}
            </button>
            <button mat-icon-button [matMenuTriggerFor]="actionsMenu" (click)="$event.stopPropagation()">
              <mat-icon>more_horiz</mat-icon>
            </button>
            <mat-menu #actionsMenu="matMenu">
              <button mat-menu-item
                      *ngIf="canConfirm(reservation.status)"
                      (click)="onConfirmReservation(reservation, $event)">
                <mat-icon>check_circle</mat-icon>
                <span>{{ 'RESERVATIONS.ACTIONS.CONFIRM' | translate }}</span>
              </button>
              <button mat-menu-item
                      *ngIf="canCancel(reservation.status)"
                      (click)="onCancelReservation(reservation, $event)">
                <mat-icon>cancel</mat-icon>
                <span>{{ 'RESERVATIONS.ACTIONS.CANCEL' | translate }}</span>
              </button>
              <button mat-menu-item (click)="exportSingleReservation(reservation)">
                <mat-icon>download</mat-icon>
                <span>{{ 'RESERVATIONS.ACTIONS.EXPORT_CSV' | translate }}</span>
              </button>
              <button mat-menu-item
                      *ngIf="reservation.status === 'CANCELLED'"
                      (click)="onDeleteReservation(reservation, $event)"
                      class="delete-menu-item">
                <mat-icon color="warn">delete</mat-icon>
                <span>{{ 'RESERVATIONS.ACTIONS.DELETE_PERMANENT' | translate }}</span>
              </button>
            </mat-menu>
          </div>
        </div>
      </div>

      <!-- Paginator -->
      <mat-paginator
        [pageSizeOptions]="[5, 10, 20, 50]"
        [pageSize]="10"
        [showFirstLastButtons]="true"
        (page)="onPageChange($event)"
        class="table-paginator">
      </mat-paginator>
    </div>

    <!-- Detail Panel (Side Panel) -->
    <div class="detail-panel" *ngIf="isDetailPanelOpen && selectedReservation">
      <div class="detail-card">

        <!-- Header con Estado -->
        <div class="detail-header">
          <div class="detail-title-section">
            <h2 class="detail-title">{{ 'RESERVATIONS.DETAIL.TITLE' | translate }}</h2>
            <div class="detail-id">ID: {{ selectedReservation.id }}</div>
          </div>
          <app-status-pill [status]="selectedReservation.status"></app-status-pill>
        </div>

        <div class="detail-content">

          <!-- Información del Cliente -->
          <div class="detail-section">
            <h3 class="section-title">{{ 'RESERVATIONS.DETAIL.CLIENT_INFO' | translate }}</h3>
            <div class="client-detail-info">
              <div class="client-avatar-large">
                {{ getInitials(selectedReservation.userName || 'U') }}
              </div>
              <div class="client-data">
                <div class="client-name-large">{{ selectedReservation.userName || ('COMMON.N_A' | translate) }}</div>
                <div class="client-contact">
                  <mat-icon class="contact-icon">email</mat-icon>
                  <span>{{ selectedReservation.userEmail || ('COMMON.N_A' | translate) }}</span>
                </div>
                <div class="client-contact" *ngIf="selectedReservation.vehiclePlate">
                  <mat-icon class="contact-icon">directions_car</mat-icon>
                  <span>{{ 'RESERVATIONS.DETAIL.PLATE' | translate }}: {{ selectedReservation.vehiclePlate }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Información del Parking -->
          <div class="detail-section">
            <h3 class="section-title">{{ 'RESERVATIONS.DETAIL.PARKING_INFO' | translate }}</h3>
            <div class="parking-detail-info">
              <div class="parking-item">
                <mat-icon class="detail-icon">local_parking</mat-icon>
                <div class="parking-detail-text">
                  <div class="parking-value">{{ selectedReservation.parkingName || ('COMMON.N_A' | translate) }}</div>
                </div>
              </div>
              <div class="parking-item">
                <mat-icon class="detail-icon">location_on</mat-icon>
                <div class="parking-detail-text">
                  <div class="parking-value">{{ 'RESERVATIONS.DETAIL.SPACE' | translate }} {{ selectedReservation.space || ('COMMON.N_A' | translate) }}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Detalles de la Reserva -->
          <div class="detail-section">
            <h3 class="section-title">{{ 'RESERVATIONS.DETAIL.RESERVATION_DETAILS' | translate }}</h3>
            <div class="reservation-details">
              <div class="detail-item">
                <mat-icon class="detail-icon">calendar_today</mat-icon>
                <div class="detail-text">
                  <div class="detail-value">{{ formatDate(selectedReservation.startTime) }}</div>
                </div>
              </div>
              <div class="detail-item">
                <mat-icon class="detail-icon">schedule</mat-icon>
                <div class="detail-text">
                  <div class="detail-value">
                    {{ formatTimeRange(selectedReservation.startTime, selectedReservation.endTime) }}
                    ({{ calculateDuration(selectedReservation.startTime, selectedReservation.endTime) }})
                  </div>
                </div>
              </div>
              <div class="detail-item">
                <mat-icon class="detail-icon">payments</mat-icon>
                <div class="detail-text">
                  <div class="detail-value price-highlight">
                    {{ formatCurrencySimple(selectedReservation.totalPrice, selectedReservation.currency) }}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="detail-actions">
            <button mat-flat-button
                    class="action-btn edit-btn"
                    *ngIf="canEdit(selectedReservation.status)">
              <mat-icon>edit</mat-icon>
              {{ 'RESERVATIONS.BUTTON.EDIT' | translate }}
            </button>

            <button mat-stroked-button
                    class="action-btn paid-btn"
                    *ngIf="canMarkAsPaid(selectedReservation.status)"
                    (click)="onMarkAsPaid(selectedReservation)">
              <mat-icon>payment</mat-icon>
              {{ 'RESERVATIONS.BUTTON.MARK_AS_PAID' | translate }}
            </button>

            <button mat-stroked-button
                    class="action-btn cancel-btn"
                    *ngIf="canCancel(selectedReservation.status)"
                    (click)="onCancelReservation(selectedReservation, $event)">
              <mat-icon>cancel</mat-icon>
              {{ 'RESERVATIONS.BUTTON.CANCEL' | translate }}
            </button>
          </div>

          <!-- Metadata -->
          <div class="detail-metadata">
            <div class="metadata-item">{{ 'RESERVATIONS.METADATA.CREATED_AT' | translate }} {{ formatFullDate(selectedReservation.createdAt) }}</div>
            <div class="metadata-item">{{ 'RESERVATIONS.METADATA.UPDATED_AT' | translate }} {{ getTimeAgo(selectedReservation.updatedAt) }}</div>
          </div>

        </div>
      </div>
    </div>

  </div>
</div>
