<div class="spots-visualizer-container">

  <!-- Panel de KPIs/Resumen -->
  <div class="statistics-panel">
    <mat-card class="stat-card stat-total">
      <mat-card-content>
        <div class="stat-icon">
          <mat-icon>grid_view</mat-icon>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ statistics.total }}</div>
          <div class="stat-label">{{ 'SPOTS.KPI.TOTAL' | translate }}</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card stat-available">
      <mat-card-content>
        <div class="stat-icon">
          <mat-icon>check_circle</mat-icon>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ statistics.available }}</div>
          <div class="stat-label">{{ 'SPOTS.KPI.AVAILABLE' | translate }}</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card stat-occupied">
      <mat-card-content>
        <div class="stat-icon">
          <mat-icon>local_parking</mat-icon>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ statistics.occupied }}</div>
          <div class="stat-label">{{ 'SPOTS.KPI.OCCUPIED' | translate }}</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card stat-reserved">
      <mat-card-content>
        <div class="stat-icon">
          <mat-icon>event_seat</mat-icon>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ statistics.reserved }}</div>
          <div class="stat-label">{{ 'SPOTS.KPI.RESERVED' | translate }}</div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Leyenda y Filtros -->
  <div class="legend-filters-container">
    <div class="legend-label">
      <mat-icon>filter_list</mat-icon>
      <span>{{ 'SPOTS.FILTER.LABEL' | translate }}</span>
    </div>

    <div class="filter-chips">
      <mat-chip-option
        *ngFor="let filter of filterOptions"
        [ngClass]="{
          'chip-available': filter.value === 'available',
          'chip-occupied': filter.value === 'occupied',
          'chip-reserved': filter.value === 'reserved',
          'selected': currentFilter === filter.value
        }"
        (click)="applyFilter(filter.value)"
      >
        <mat-icon>{{ filter.icon }}</mat-icon>
        {{ filter.label }}
        <span class="chip-count" *ngIf="filter.value !== 'all'">
          ({{ getFilterCount(filter.value) }})
        </span>
      </mat-chip-option>
    </div>
  </div>

  <!-- Grid/Strip horizontal de spots con Virtual Scroll -->
  <div class="spots-container">
    <h3 class="section-title">
      <mat-icon>grid_view</mat-icon>
      {{ 'SPOTS.SECTION.TITLE' | translate }}
    </h3>

    <div class="spots-scroll-hint" *ngIf="totalSpots > 20">
      <mat-icon>swipe</mat-icon>
      <span>{{ 'SPOTS.HINT.SWIPE' | translate }}</span>
    </div>

    <cdk-virtual-scroll-viewport
      orientation="horizontal"
      [itemSize]="156"
      class="spots-viewport"
    >
      <div class="spots-grid">
        <app-spot-block
          *cdkVirtualFor="let spot of filteredSpots; trackBy: trackBySpotNumber"
          [id]="getSpotNumberFromLabel(spot.label)"
          [spotNumber]="getSpotNumberFromLabel(spot.label)"
          [status]="spot.status"
          [deviceId]="spot.deviceId || null"
          (openDetails)="onOpenDeviceDetails($event)"
          (markAsAvailable)="onMarkAsAvailable($event)"
          (markAsOccupied)="onMarkAsOccupied($event)"
        ></app-spot-block>
      </div>
    </cdk-virtual-scroll-viewport>
  </div>

  <!-- SecciÃ³n de Dispositivos IoT Disponibles -->
  <div class="devices-container">
    <h3 class="section-title">
      <mat-icon>sensors</mat-icon>
      {{ 'SPOTS.DEVICES.TITLE' | translate }} ({{ availableDevices.length }})
    </h3>

    <div class="devices-info" *ngIf="availableDevices.length === 0">
      <mat-icon class="info-icon">info</mat-icon>
      <p>{{ 'SPOTS.DEVICES.NO_AVAILABLE' | translate }} <a routerLink="/iot/devices">{{ 'SPOTS.DEVICES.LINK' | translate }}</a></p>
    </div>

    <div class="devices-grid" *ngIf="availableDevices.length > 0">
      <mat-card
        *ngFor="let device of availableDevices"
        class="device-card"
        [class.assigned]="device.parkingSpotLabel"
      >
        <mat-card-content>
          <div class="device-header">
            <mat-icon class="device-icon">{{ getDeviceIcon(device.type) }}</mat-icon>
            <div class="device-info-header">
              <h4 class="device-name">{{ device.model }}</h4>
              <span class="device-serial">{{ device.serialNumber }}</span>
            </div>
          </div>

          <div class="device-stats">
            <div class="device-stat">
              <mat-icon class="stat-icon">battery_charging_full</mat-icon>
              <span>{{ device.battery }}%</span>
            </div>
            <div class="device-stat">
              <mat-icon class="stat-icon">signal_cellular_alt</mat-icon>
              <span>85%</span>
            </div>
          </div>

          <div class="device-status" *ngIf="device.parkingSpotLabel">
            <mat-chip class="assigned-chip">
              <mat-icon>link</mat-icon>
              {{ 'SPOTS.DEVICES.ASSIGNED_TO' | translate }} {{ device.parkingSpotLabel }}
            </mat-chip>
          </div>

          <div class="device-actions">
            <!-- BotÃ³n de prueba temporal -->
            <button
              mat-stroked-button
              color="accent"
              (click)="testClick()"
              class="test-button"
              style="margin-bottom: 8px;"
            >
              ðŸ§ª PRUEBA
            </button>

            <button
              mat-raised-button
              color="primary"
              (click)="onAssignDevice(device)"
              class="assign-button"
            >
              <mat-icon>add_link</mat-icon>
              {{ device.parkingSpotLabel ? 'Reasignar' : ('SPOTS.DEVICES.ASSIGN' | translate) }}
            </button>

            <button
              mat-stroked-button
              color="warn"
              *ngIf="device.parkingSpotLabel"
              (click)="unassignDevice(device.id)"
              class="unassign-button"
            >
              <mat-icon>link_off</mat-icon>
              {{ 'SPOTS.DEVICES.UNASSIGN' | translate }}
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>


</div>
