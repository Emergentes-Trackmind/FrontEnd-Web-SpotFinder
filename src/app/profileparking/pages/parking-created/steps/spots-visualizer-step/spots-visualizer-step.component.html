<div class="spots-visualizer-container">

  <!-- Panel de KPIs/Resumen -->
  <div class="statistics-panel">
    <mat-card class="stat-card stat-total">
      <mat-card-content>
        <div class="stat-icon">
          <mat-icon>grid_view</mat-icon>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ statistics.total }}</div>
          <div class="stat-label">{{ 'SPOTS.KPI.TOTAL' | translate }}</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card stat-free">
      <mat-card-content>
        <div class="stat-icon">
          <mat-icon>check_circle</mat-icon>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ statistics.free }}</div>
          <div class="stat-label">{{ 'SPOTS.KPI.FREE' | translate }}</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card stat-occupied">
      <mat-card-content>
        <div class="stat-icon">
          <mat-icon>local_parking</mat-icon>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ statistics.occupied }}</div>
          <div class="stat-label">{{ 'SPOTS.KPI.OCCUPIED' | translate }}</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card stat-maintenance">
      <mat-card-content>
        <div class="stat-icon">
          <mat-icon>engineering</mat-icon>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ statistics.maintenance }}</div>
          <div class="stat-label">{{ 'SPOTS.KPI.MAINTENANCE' | translate }}</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card stat-offline">
      <mat-card-content>
        <div class="stat-icon">
          <mat-icon>wifi_off</mat-icon>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ statistics.offline }}</div>
          <div class="stat-label">{{ 'SPOTS.KPI.OFFLINE' | translate }}</div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Leyenda y Filtros -->
  <div class="legend-filters-container">
    <div class="legend-label">
      <mat-icon>filter_list</mat-icon>
      <span>{{ 'SPOTS.FILTER.LABEL' | translate }}</span>
    </div>

    <div class="filter-chips">
      <mat-chip-option
        *ngFor="let filter of filterOptions"
        [ngClass]="{
          'chip-free': filter.value === 'free',
          'chip-occupied': filter.value === 'occupied',
          'chip-maintenance': filter.value === 'maintenance',
          'chip-offline': filter.value === 'offline',
          'selected': currentFilter === filter.value
        }"
        (click)="applyFilter(filter.value)"
      >
        <mat-icon>{{ filter.icon }}</mat-icon>
        {{ filter.label }}
        <span class="chip-count" *ngIf="filter.value !== 'all'">
          ({{ statistics[filter.value] }})
        </span>
      </mat-chip-option>
    </div>
  </div>

  <!-- Grid/Strip horizontal de spots con Virtual Scroll -->
  <div class="spots-container">
    <h3 class="section-title">
      <mat-icon>grid_view</mat-icon>
      {{ 'SPOTS.SECTION.TITLE' | translate }}
    </h3>

    <div class="spots-scroll-hint" *ngIf="totalSpots > 20">
      <mat-icon>swipe</mat-icon>
      <span>{{ 'SPOTS.HINT.SWIPE' | translate }}</span>
    </div>

    <cdk-virtual-scroll-viewport
      orientation="horizontal"
      [itemSize]="156"
      class="spots-viewport"
    >
      <div class="spots-grid">
        <app-spot-block
          *cdkVirtualFor="let spot of filteredSpots; trackBy: trackBySpotNumber"
          [id]="spot.id"
          [spotNumber]="spot.spotNumber"
          [status]="spot.status"
          [deviceId]="spot.deviceId"
          [inMaintenance]="spot.inMaintenance"
          (openDetails)="onOpenDeviceDetails($event)"
          (setMaintenance)="onSetMaintenance($event)"
        ></app-spot-block>
      </div>
    </cdk-virtual-scroll-viewport>
  </div>

  <!-- SecciÃ³n de Dispositivos IoT Disponibles -->
  <div class="devices-container">
    <h3 class="section-title">
      <mat-icon>sensors</mat-icon>
      {{ 'SPOTS.DEVICES.TITLE' | translate }} ({{ availableDevices.length }})
    </h3>

    <div class="devices-info" *ngIf="availableDevices.length === 0">
      <mat-icon class="info-icon">info</mat-icon>
      <p>{{ 'SPOTS.DEVICES.NO_AVAILABLE' | translate }} <a routerLink="/iot/devices">{{ 'SPOTS.DEVICES.LINK' | translate }}</a></p>
    </div>

    <div class="devices-grid" *ngIf="availableDevices.length > 0">
      <mat-card
        *ngFor="let device of availableDevices"
        class="device-card"
        [class.assigned]="device.spotNumber"
      >
        <mat-card-content>
          <div class="device-header">
            <mat-icon class="device-icon">{{ getDeviceIcon(device.type) }}</mat-icon>
            <div class="device-info-header">
              <h4 class="device-name">{{ device.name }}</h4>
              <span class="device-serial">{{ device.serialNumber }}</span>
            </div>
          </div>

          <div class="device-stats">
            <div class="device-stat">
              <mat-icon class="stat-icon">battery_charging_full</mat-icon>
              <span>{{ device.battery }}%</span>
            </div>
            <div class="device-stat">
              <mat-icon class="stat-icon">signal_cellular_alt</mat-icon>
              <span>{{ device.signalStrength }}%</span>
            </div>
          </div>

          <div class="device-status" *ngIf="device.spotNumber">
            <mat-chip class="assigned-chip">
              <mat-icon>link</mat-icon>
              {{ 'SPOTS.DEVICES.ASSIGNED_TO' | translate }} {{ device.spotNumber }}
            </mat-chip>
          </div>

          <div class="device-actions">
            <button
              mat-raised-button
              color="primary"
              *ngIf="!device.spotNumber"
              [matMenuTriggerFor]="spotMenu"
              class="assign-button"
            >
              <mat-icon>add_link</mat-icon>
              {{ 'SPOTS.DEVICES.ASSIGN' | translate }}
            </button>

            <button
              mat-stroked-button
              color="warn"
              *ngIf="device.spotNumber"
              (click)="unassignDevice(device.id)"
              class="unassign-button"
            >
              <mat-icon>link_off</mat-icon>
              {{ 'SPOTS.DEVICES.UNASSIGN' | translate }}
            </button>

            <mat-menu #spotMenu="matMenu" class="spot-menu">
              <div class="spot-menu-header">{{ 'SPOTS.DEVICES.MENU.SELECT_SPOT' | translate }}</div>
              <button
                mat-menu-item
                *ngFor="let spot of getAvailableSpots()"
                (click)="assignDeviceToSpot(device.id, spot.spotNumber)"
              >
                <mat-icon>place</mat-icon>
                {{ 'SPOTS.DEVICES.MENU.SPOT' | translate }} {{ spot.spotNumber }}
              </button>
              <div class="spot-menu-empty" *ngIf="getAvailableSpots().length === 0">
                {{ 'SPOTS.DEVICES.MENU.ALL_ASSIGNED' | translate }}
              </div>
            </mat-menu>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>


</div>
