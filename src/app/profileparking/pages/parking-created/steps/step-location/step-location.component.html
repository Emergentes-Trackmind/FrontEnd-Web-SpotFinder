<mat-card class="step-card">
  <mat-card-header class="step-header">
    <mat-card-title>{{ 'PARKING_STEPS.LOCATION.TITLE' | translate }}</mat-card-title>
    <mat-card-subtitle>{{ 'PARKING_STEPS.LOCATION.SUBTITLE' | translate }}</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content class="step-content">
    <form [formGroup]="locationForm" class="location-form">

      <!-- Primera fila: Dirección y Ciudad -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>{{ 'PARKING_STEPS.LOCATION.LABELS.ADDRESS' | translate }} *</mat-label>
          <input
            matInput
            formControlName="addressLine"
            [placeholder]="'PARKING_STEPS.LOCATION.PLACEHOLDERS.ADDRESS' | translate"
            maxlength="200">
          <mat-icon matSuffix>place</mat-icon>
          <mat-error *ngIf="isFieldInvalid('addressLine')">
            {{ getErrorMessage('addressLine') }}
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>{{ 'PARKING_STEPS.LOCATION.LABELS.CITY' | translate }} *</mat-label>
          <input
            matInput
            formControlName="city"
            [placeholder]="'PARKING_STEPS.LOCATION.PLACEHOLDERS.CITY' | translate"
            maxlength="100">
          <mat-icon matSuffix>location_city</mat-icon>
          <mat-error *ngIf="isFieldInvalid('city')">
            {{ getErrorMessage('city') }}
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Segunda fila: Código Postal, Provincia y País -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>{{ 'PARKING_STEPS.LOCATION.LABELS.POSTAL_CODE' | translate }} *</mat-label>
          <input
            matInput
            formControlName="postalCode"
            [placeholder]="'PARKING_STEPS.LOCATION.PLACEHOLDERS.POSTAL_CODE' | translate"
            maxlength="5">
          <mat-icon matSuffix>markunread_mailbox</mat-icon>
          <mat-error *ngIf="isFieldInvalid('postalCode')">
            {{ getErrorMessage('postalCode') }}
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>{{ 'PARKING_STEPS.LOCATION.LABELS.STATE' | translate }}</mat-label>
          <input
            matInput
            formControlName="state"
            [placeholder]="'PARKING_STEPS.LOCATION.PLACEHOLDERS.STATE' | translate"
            maxlength="100">
          <mat-icon matSuffix>map</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>{{ 'PARKING_STEPS.LOCATION.LABELS.COUNTRY' | translate }} *</mat-label>
          <input
            matInput
            formControlName="country"
            [placeholder]="'PARKING_STEPS.LOCATION.PLACEHOLDERS.COUNTRY' | translate">
          <mat-icon matSuffix>flag</mat-icon>
          <mat-error *ngIf="isFieldInvalid('country')">
            {{ getErrorMessage('country') }}
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Sección del mapa -->
      <div class="map-section">
        <div class="map-header">
          <div class="map-title">
            <mat-icon>location_on</mat-icon>
            <span>{{ 'PARKING_STEPS.LOCATION.MAP.TITLE' | translate }}</span>
          </div>

          <!-- Botón de ubicación actual -->
          <button
            mat-stroked-button
            type="button"
            (click)="onUseCurrentLocation()"
            [disabled]="isLoadingCurrentLocation"
            class="current-location-btn">
            <mat-icon *ngIf="!isLoadingCurrentLocation">my_location</mat-icon>
            <mat-progress-spinner
              *ngIf="isLoadingCurrentLocation"
              diameter="16"
              mode="indeterminate">
            </mat-progress-spinner>
            {{ 'PARKING_STEPS.LOCATION.BUTTON.USE_MY_LOCATION' | translate }}
          </button>
        </div>

        <div class="map-description">
          <p>{{ 'PARKING_STEPS.LOCATION.MAP.DESCRIPTION_1' | translate }}</p>
          <p>{{ 'PARKING_STEPS.LOCATION.MAP.DESCRIPTION_2' | translate }}</p>
        </div>

        <!-- Componente del mapa -->
        <div class="map-container">
          <app-map
            [center]="mapCenter"
            [zoom]="15"
            [markerDraggable]="true"
            [height]="'320px'"
            [showCurrentLocationButton]="false"
            (mapClicked)="onMapClicked($event)"
            (markerMoved)="onMarkerMoved($event)">
          </app-map>
        </div>

        <!-- Loading indicator para geocodificación -->
        <div *ngIf="isGeocoding" class="geocoding-loading">
          <mat-progress-spinner diameter="24" mode="indeterminate"></mat-progress-spinner>
          <span>{{ 'PARKING_STEPS.LOCATION.GEOCODING.SEARCHING' | translate }}</span>
        </div>

        <!-- Resultados de geocodificación -->
        <div *ngIf="geocodeResults.length > 0" class="geocode-results">
          <h4>{{ 'PARKING_STEPS.LOCATION.GEOCODING.RESULTS_TITLE' | translate }}</h4>
          <div class="results-list">
            <button
              *ngFor="let result of geocodeResults; let i = index"
              mat-stroked-button
              type="button"
              (click)="onGeocodeResultSelected(result)"
              class="result-item">
              <mat-icon>place</mat-icon>
              <span>{{ result.displayName }}</span>
            </button>
          </div>
        </div>

        <!-- Coordenadas -->
        <div class="coordinates-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>{{ 'PARKING_STEPS.LOCATION.LABELS.LATITUDE' | translate }}</mat-label>
            <input
              matInput
              type="number"
              formControlName="latitude"
              step="0.000001"
              readonly>
            <mat-icon matSuffix>explore</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>{{ 'PARKING_STEPS.LOCATION.LABELS.LONGITUDE' | translate }}</mat-label>
            <input
              matInput
              type="number"
              formControlName="longitude"
              step="0.000001"
              readonly>
            <mat-icon matSuffix>explore</mat-icon>
          </mat-form-field>
        </div>
      </div>

    </form>
  </mat-card-content>
</mat-card>
